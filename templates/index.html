<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="MedRush - Your trusted online medical consultation platform">
    <title>MedRush - Your Health, Our Priority</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary sticky-top shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-heartbeat me-2"></i>
                MedRush
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#home">
                            <i class="fas fa-home me-1"></i> Home
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#ai-section">
                            <i class="fas fa-robot me-1"></i> AI Assistant
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#prescription-section">
                            <i class="fas fa-pills me-1"></i> Prescription Check
                        </a>
                    </li>
                </ul>
                <div class="d-flex">
                    {% if current_user.is_authenticated %}
                        <a href="{{ url_for('profile') }}" class="btn btn-outline-light me-2">
                            <i class="fas fa-user me-1"></i> Profile
                        </a>
                        <button class="btn btn-outline-light logout-btn">
                            <i class="fas fa-sign-out-alt me-1"></i> Logout
                        </button>
                    {% else %}
                        <button class="btn btn-outline-light me-2" data-bs-toggle="modal" data-bs-target="#loginModal">
                            <i class="fas fa-sign-in-alt me-1"></i> Login
                        </button>
                        <a href="{{ url_for('signup') }}" class="btn btn-light">
                            <i class="fas fa-user-plus me-1"></i> Sign Up
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section id="home" class="hero-section">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-6">
                    <div class="hero-content">
                        <h1 class="display-4">Welcome to MedRush</h1>
                        <p class="lead">Your Trusted Healthcare Partner</p>
                        <div class="hero-buttons">
                            {% if current_user.is_authenticated %}
                            <a href="/profile" class="btn btn-primary hero-btn">
                                <i class="fas fa-user-circle"></i> My Profile
                            </a>
                            <a href="#chat-section" class="btn btn-outline-primary hero-btn">
                                <i class="fas fa-robot"></i> Chat with AI
                            </a>
                            {% else %}
                            <a href="{{ url_for('signup') }}" class="btn btn-primary hero-btn">
                                <i class="fas fa-user-plus"></i> Join Now
                            </a>
                            <button class="btn btn-outline-primary hero-btn" data-bs-toggle="modal" data-bs-target="#loginModal">
                                <i class="fas fa-sign-in-alt"></i> Login
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Stats Section -->
    <div class="stats-section py-5">
        <div class="container">
            <div class="row justify-content-center text-center">
                <div class="col-md-3 col-sm-6 mb-4">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-user-md fa-3x"></i>
                        </div>
                        <div class="stat-number" data-target="500">500+</div>
                        <div class="stat-label">Expert Doctors</div>
                        <div class="stat-description">Qualified Healthcare Professionals</div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6 mb-4">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-hospital fa-3x"></i>
                        </div>
                        <div class="stat-number" data-target="50">50+</div>
                        <div class="stat-label">Partner Hospitals</div>
                        <div class="stat-description">Leading Medical Facilities</div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6 mb-4">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-smile fa-3x"></i>
                        </div>
                        <div class="stat-number" data-target="10000">10,000+</div>
                        <div class="stat-label">Happy Patients</div>
                        <div class="stat-description">Satisfied with Our Service</div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6 mb-4">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-clock fa-3x"></i>
                        </div>
                        <div class="stat-number">< 10min</div>
                        <div class="stat-label">Response Time</div>
                        <div class="stat-description">Quick Medical Assistance</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Features Section -->
    <section class="features-section py-5">
        <div class="container">
            <div class="section-header text-center mb-5">
                <h2 class="display-4 fw-bold">Our Services</h2>
                <p class="lead text-muted">Comprehensive healthcare solutions at your fingertips</p>
            </div>
            <div class="row g-4">
                <!-- Smart Healthcare Management -->
                <div class="col-md-4">
                    <div class="feature-card h-100">
                        <div class="card-body text-center">
                            <div class="icon-circle mb-4">
                                <i class="fas fa-calendar-check"></i>
                            </div>
                            <h3>Smart Healthcare Management</h3>
                            <p class="text-muted">Book appointments and reserve hospital beds seamlessly through our integrated system.</p>
                            <ul class="feature-list">
                                <li><i class="fas fa-check-circle"></i> Online doctor appointments</li>
                                <li><i class="fas fa-check-circle"></i> Hospital bed availability</li>
                                <li><i class="fas fa-check-circle"></i> Real-time updates</li>
                                <li><i class="fas fa-check-circle"></i> Instant confirmations</li>
                            </ul>
                            {% if current_user.is_authenticated %}
                            <a href="/book-appointment" class="btn btn-primary mt-3 rounded-pill">Book Now</a>
                            {% else %}
                            <a href="/login" class="btn btn-primary mt-3 rounded-pill">Login to Book</a>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Dark Ambulance -->
                <div class="col-md-4">
                    <div class="feature-card h-100 emergency-card">
                        <div class="card-body text-center">
                            <div class="icon-circle emergency-icon mb-4">
                                <i class="fas fa-ambulance"></i>
                            </div>
                            <h3>Ambulance</h3>
                            <p class="text-muted">Emergency medical transport in under 10 minutes, available 24/7.</p>
                            <ul class="feature-list">
                                <li><i class="fas fa-check-circle"></i> Real-time GPS tracking</li>
                                <li><i class="fas fa-check-circle"></i> Advanced life support</li>
                                <li><i class="fas fa-check-circle"></i> Trained responders</li>
                                <li><i class="fas fa-check-circle"></i> Hospital coordination</li>
                            </ul>
                            <button class="btn btn-danger mt-3 rounded-pill emergency-btn">
                                <i class="fas fa-phone-alt me-2"></i>Emergency Call
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Insurance Support -->
                <div class="col-md-4">
                    <div class="feature-card h-100">
                        <div class="card-body text-center">
                            <div class="icon-circle mb-4">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <h3>Insurance Support</h3>
                            <p class="text-muted">Comprehensive insurance coverage and claims assistance for hassle-free healthcare.</p>
                            <ul class="feature-list">
                                <li><i class="fas fa-check-circle"></i> Insurance verification</li>
                                <li><i class="fas fa-check-circle"></i> Claims processing</li>
                                <li><i class="fas fa-check-circle"></i> Coverage analysis</li>
                                <li><i class="fas fa-check-circle"></i> 24/7 support</li>
                            </ul>
                            {% if current_user.is_authenticated %}
                            <a href="/insurance" class="btn btn-primary mt-3 rounded-pill">Check Coverage</a>
                            {% else %}
                            <a href="/login" class="btn btn-primary mt-3 rounded-pill">Login to Check</a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Chat Section with Prescription Verification -->
    <div id="ai-section" class="container my-4">
        <div class="row justify-content-center">
            <!-- AI Chat Section (Made Smaller) -->
            <div class="col-md-5">
                <div class="chat-section mb-4">
                    <div class="card shadow-lg">
                        <div class="card-header bg-gradient bg-primary text-white py-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="fas fa-robot me-2"></i> AI Health Assistant
                                </h5>
                                <button id="langToggle" class="btn btn-outline-light btn-sm">
                                    <i class="fas fa-language me-1"></i>
                                    <span id="langText">Switch to Hinglish</span>
                                </button>
                            </div>
                        </div>
                        <div class="card-body chat-messages p-0" id="chat-messages" style="height: 400px; overflow-y: auto;">
                            <div class="p-3">
                                <div class="message ai-message">
                                    <div class="message-content">
                                        <i class="fas fa-robot text-primary me-2"></i>
                                        Hello! I'm your AI Health Assistant. How can I help you today?
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer bg-light p-2">
                            <form id="chat-form" class="mb-0" onsubmit="chatAssistant.sendMessage(event)">
                                <div class="input-group">
                                    <input type="text" 
                                           id="user-input" 
                                           class="form-control border-primary" 
                                           placeholder="Ask me about your health concerns..."
                                           autocomplete="off">
                                    <button type="submit" class="btn btn-primary px-4">
                                        <i class="fas fa-paper-plane"></i>
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Prescription Verification Section -->
            <div class="col-md-5">
                <div class="prescription-section mb-4">
                    <div class="card shadow-lg">
                        <div class="card-header bg-gradient bg-primary text-white py-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="fas fa-pills me-2"></i> Prescription Verification
                                </h5>
                                <button id="clearPrescription" class="btn btn-outline-light btn-sm">
                                    <i class="fas fa-trash me-1"></i> Clear
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="prescription-messages mb-3" id="prescription-messages">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i> Upload your prescription or list your medications for a safety check.
                                </div>
                            </div>
                            <div class="prescription-form">
                                <div class="mb-3">
                                    <label for="medications" class="form-label">
                                        <i class="fas fa-list-ul me-2"></i>List Your Medications
                                    </label>
                                    <textarea class="form-control border-primary" id="medications" rows="3" 
                                        placeholder="Enter each medication on a new line with dosage (e.g., Aspirin 81mg daily)"></textarea>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-file-medical me-2"></i>Or Upload Prescription Image
                                    </label>
                                    <input type="file" class="form-control border-primary" id="prescription-image" accept="image/*">
                                </div>
                                <div class="mb-3">
                                    <label for="additional-notes" class="form-label">
                                        <i class="fas fa-notes-medical me-2"></i>Additional Notes
                                    </label>
                                    <textarea class="form-control border-primary" id="additional-notes" rows="2"
                                        placeholder="Any allergies or current conditions we should know about?"></textarea>
                                </div>
                                <button class="btn btn-primary w-100" onclick="verifyPrescription()">
                                    <i class="fas fa-check-circle me-2"></i> Verify Medications
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    
    <style>
        .chat-messages {
            background: #f8f9fa;
        }
        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 10px;
        }
        .user-message {
            background: #e3f2fd;
            margin-left: 20%;
            margin-right: 10px;
        }
        .ai-message {
            background: white;
            margin-right: 20%;
            margin-left: 10px;
            border-left: 4px solid #0d6efd;
        }
        .message-content {
            word-wrap: break-word;
        }
        .chat-input input {
            border-radius: 20px;
            padding-left: 20px;
        }
        .card {
            border: none;
            border-radius: 15px;
        }
        .card-header {
            border-top-left-radius: 15px !important;
            border-top-right-radius: 15px !important;
        }
        .form-control:focus {
            box-shadow: none;
            border-color: #0d6efd;
        }
        .btn-primary {
            border-radius: 20px;
        }
        .chat-messages {
            padding: 1rem;
        }
        .message {
            margin-bottom: 1rem;
            padding: 0.5rem 1rem;
            border-radius: 15px;
        }
        .user-message {
            color: #2c3e50;
            background-color: #e8f4f8;
            margin-left: 20%;
            border-top-right-radius: 5px;
        }
        .ai-message {
            color: #2c3e50;
            background-color: #f8f9fa;
            margin-right: 20%;
            border-top-left-radius: 5px;
        }
        .ai-message ul {
            padding-left: 20px;
            margin: 10px 0;
        }
        .ai-message li {
            margin: 5px 0;
        }
        .message-content {
            word-wrap: break-word;
        }
    </style>

    <script>
        // ChatAssistant class for handling chat functionality
        class ChatAssistant {
            constructor() {
                this.messages = document.getElementById('chat-messages');
                this.userInput = document.getElementById('user-input');
                this.language = 'english';
                this.initializeChat();
            }

            initializeChat() {
                // Clear existing messages
                this.messages.innerHTML = '<div class="p-3"><div class="message ai-message"><div class="message-content"><i class="fas fa-robot text-primary me-2"></i>Hello! I\'m your AI Health Assistant. How can I help you today?</div></div></div>';
                
                // Add clear chat button functionality
                document.getElementById('clearChat').addEventListener('click', () => {
                    this.clearChat();
                });
            }

            clearChat() {
                // Reset to initial state
                this.initializeChat();
                // Clear any stored chat history
                localStorage.removeItem('chatHistory');
            }

            async sendMessage(event) {
                event.preventDefault();
                const message = this.userInput.value.trim();
                if (!message) return;

                // Add user message
                this.addMessage(message, 'user');
                this.userInput.value = '';

                // Show typing indicator
                const typingId = this.addTypingIndicator();

                try {
                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            message: message,
                            language: this.language
                        })
                    });

                    const data = await response.json();
                    
                    // Remove typing indicator
                    this.removeTypingIndicator(typingId);
                    
                    // Add AI response
                    this.addMessage(data.response, 'ai');
                    
                    // Save chat history
                    this.saveChatHistory();
                    
                    // Scroll to bottom
                    this.messages.scrollTop = this.messages.scrollHeight;

                } catch (error) {
                    console.error('Error:', error);
                    this.removeTypingIndicator(typingId);
                    this.addMessage('Sorry, I encountered an error. Please try again.', 'ai');
                }
            }

            addMessage(text, sender) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender}-message`;
                messageDiv.innerHTML = `
                    <div class="message-content">
                        ${sender === 'ai' ? '<i class="fas fa-robot text-primary me-2"></i>' : ''}
                        ${text}
                    </div>
                `;
                this.messages.appendChild(messageDiv);
                this.messages.scrollTop = this.messages.scrollHeight;
            }

            addTypingIndicator() {
                const id = 'typing-' + Date.now();
                const typingDiv = document.createElement('div');
                typingDiv.id = id;
                typingDiv.className = 'message ai-message';
                typingDiv.innerHTML = `
                    <div class="message-content">
                        <i class="fas fa-robot text-primary me-2"></i>
                        <span class="typing-dots">Thinking<span>.</span><span>.</span><span>.</span></span>
                    </div>
                `;
                this.messages.appendChild(typingDiv);
                this.messages.scrollTop = this.messages.scrollHeight;
                return id;
            }

            removeTypingIndicator(id) {
                const typingDiv = document.getElementById(id);
                if (typingDiv) {
                    typingDiv.remove();
                }
            }

            toggleLanguage() {
                this.language = this.language === 'english' ? 'hinglish' : 'english';
                const langText = document.getElementById('langText');
                langText.textContent = `Switch to ${this.language === 'english' ? 'Hinglish' : 'English'}`;
            }

            saveChatHistory() {
                const chatHistory = {
                    messages: this.messages.innerHTML,
                    language: this.language
                };
                localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
            }

            loadChatHistory() {
                const savedHistory = localStorage.getItem('chatHistory');
                if (savedHistory) {
                    const history = JSON.parse(savedHistory);
                    this.messages.innerHTML = history.messages;
                    this.language = history.language;
                    const langText = document.getElementById('langText');
                    langText.textContent = `Switch to ${this.language === 'english' ? 'Hinglish' : 'English'}`;
                }
            }
        }

        // Initialize chat assistant
        document.addEventListener('DOMContentLoaded', function() {
            const chatAssistant = new ChatAssistant();
        });

        // Language toggle button
        document.getElementById('langToggle').addEventListener('click', () => {
            chatAssistant.toggleLanguage();
        });

        // Add prescription clear functionality
        document.getElementById('clearPrescription').addEventListener('click', function() {
            // Clear form inputs
            document.getElementById('medications').value = '';
            document.getElementById('prescription-image').value = '';
            document.getElementById('additional-notes').value = '';
            
            // Reset messages
            const messagesDiv = document.getElementById('prescription-messages');
            messagesDiv.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i> Upload your prescription or list your medications for a safety check.
                </div>
            `;
        });

        // Rest of your existing script...
    </script>

    <script>
        // Add smooth scrolling for navigation
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    const headerOffset = 70; // Adjust based on navbar height
                    const elementPosition = target.getBoundingClientRect().top;
                    const offsetPosition = elementPosition + window.pageYOffset - headerOffset;

                    window.scrollTo({
                        top: offsetPosition,
                        behavior: 'smooth'
                    });
                }
            });
        });

        // Highlight active nav item based on scroll position
        window.addEventListener('scroll', function() {
            const sections = ['home', 'ai-section', 'prescription-section'];
            let current = '';

            sections.forEach(section => {
                const element = document.getElementById(section);
                if (element) {
                    const rect = element.getBoundingClientRect();
                    if (rect.top <= 100) {
                        current = section;
                    }
                }
            });

            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href') === `#${current}`) {
                    link.classList.add('active');
                }
            });
        });
    </script>

    <script>
        document.querySelector('.logout-btn').addEventListener('click', function(e) {
            e.preventDefault();
            fetch('/logout', {
                method: 'POST'
            })
            .then(() => {
                window.location.href = '/';
            });
        });
    </script>

    <!-- Login Modal -->
    <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="loginModalLabel"><i class="fas fa-sign-in-alt"></i> Login</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="login-form">
                        <div class="mb-3">
                            <label for="login-username" class="form-label">Email or Username</label>
                            <input type="text" class="form-control" id="login-username" required>
                        </div>
                        <div class="mb-3">
                            <label for="login-password" class="form-label">Password</label>
                            <input type="password" class="form-control" id="login-password" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Login</button>
                    </form>
                    <div class="text-center mt-3">
                        <p>Don't have an account? <a href="{{ url_for('signup') }}">Sign up here</a></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Signup Modal -->
    <div class="modal fade" id="signupModal" tabindex="-1" aria-labelledby="signupModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="signupModalLabel"><i class="fas fa-user-plus"></i> Sign Up</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="signup-form" onsubmit="signup(event)">
                        <div class="mb-3">
                            <label for="signup-username" class="form-label">Username</label>
                            <input type="text" class="form-control" id="signup-username" required>
                        </div>
                        <div class="mb-3">
                            <label for="signup-email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="signup-email" required>
                        </div>
                        <div class="mb-3">
                            <label for="signup-password" class="form-label">Password</label>
                            <input type="password" class="form-control" id="signup-password" required>
                            <div class="form-text">Password must be at least 8 characters long</div>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Sign Up</button>
                    </form>
                    <div class="text-center mt-3">
                        <p>Already have an account? <a href="#" onclick="openLoginModal()">Login here</a></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Emergency Map Modal -->
    <div class="modal fade" id="emergencyMapModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-ambulance me-2"></i>Emergency Response
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-0">
                    <div class="emergency-status p-3 bg-light border-bottom">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border text-danger me-3" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <div>
                                <h6 class="mb-1">Locating Nearest Ambulance</h6>
                                <p class="mb-0 text-muted" id="locationStatus">Detecting your location...</p>
                            </div>
                        </div>
                    </div>
                    <div id="emergencyMap" style="height: 400px; width: 100%;"></div>
                    <div class="emergency-info p-3">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Your Location</h6>
                                <p id="userAddress" class="mb-3">Detecting...</p>
                            </div>
                            <div class="col-md-6">
                                <h6>Estimated Arrival Time</h6>
                                <p id="estimatedTime" class="mb-3">Calculating...</p>
                            </div>
                        </div>
                        <div class="d-grid">
                            <button class="btn btn-danger" type="button" id="confirmEmergency">
                                <i class="fas fa-phone-alt me-2"></i>Confirm Emergency Call
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map;
        let userMarker;
        let hospitalMarker;
        let routingControl;

        // Update the emergency button click handler
        document.querySelector('.emergency-btn').addEventListener('click', function(e) {
            e.preventDefault();
            $('#emergencyMapModal').modal('show');
            setTimeout(() => {
                initializeEmergencyMap();
            }, 500);
        });

        function initializeEmergencyMap() {
            // Initialize the map if not already initialized
            if (!map) {
                map = L.map('emergencyMap');
                
                // Add OpenStreetMap tiles
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: ' OpenStreetMap contributors'
                }).addTo(map);
            }

            // Get user's location
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };

                        // Center map on user's location
                        map.setView([userLocation.lat, userLocation.lng], 15);

                        // Add or update user marker
                        if (userMarker) {
                            userMarker.setLatLng([userLocation.lat, userLocation.lng]);
                        } else {
                            userMarker = L.marker([userLocation.lat, userLocation.lng], {
                                icon: L.divIcon({
                                    className: 'custom-div-icon',
                                    html: '<div class="marker-pin user-location"></div>',
                                    iconSize: [30, 42],
                                    iconAnchor: [15, 42]
                                })
                            }).addTo(map);
                        }

                        // Get address using Nominatim
                        getAddressFromCoordinates(userLocation);
                        
                        // Simulate finding nearest hospital (for demo)
                        simulateNearestHospital(userLocation);
                    },
                    function(error) {
                        document.getElementById('locationStatus').innerHTML = 
                            'Error: Unable to retrieve your location';
                    }
                );
            }
        }

        function getAddressFromCoordinates(location) {
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${location.lat}&lon=${location.lng}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('userAddress').innerHTML = data.display_name;
                })
                .catch(error => {
                    document.getElementById('userAddress').innerHTML = 'Address lookup failed';
                });
        }

        function simulateNearestHospital(userLocation) {
            // Simulate a nearby hospital location (offset from user location)
            const hospitalLocation = {
                lat: userLocation.lat + 0.01,
                lng: userLocation.lng + 0.01
            };

            // Add or update hospital marker
            if (hospitalMarker) {
                hospitalMarker.setLatLng([hospitalLocation.lat, hospitalLocation.lng]);
            } else {
                hospitalMarker = L.marker([hospitalLocation.lat, hospitalLocation.lng], {
                    icon: L.divIcon({
                        className: 'custom-div-icon',
                        html: '<div class="marker-pin hospital-location"></div>',
                        iconSize: [30, 42],
                        iconAnchor: [15, 42]
                    })
                }).addTo(map);
            }

            // Calculate and display route
            calculateRoute(userLocation, hospitalLocation);
        }

        function calculateRoute(start, end) {
            // Remove existing route if any
            if (routingControl) {
                map.removeControl(routingControl);
            }

            // Calculate straight-line distance
            const distance = calculateDistance(start.lat, start.lng, end.lat, end.lng);
            const estimatedMinutes = Math.round((distance / 50) * 60); // Assuming 50 km/h average speed

            // Update estimated time
            document.getElementById('estimatedTime').innerHTML = `${estimatedMinutes} minutes`;
            document.getElementById('locationStatus').innerHTML = 'Nearest ambulance located. Ready to dispatch.';

            // Draw a simple line between points
            const routeLine = L.polyline([
                [start.lat, start.lng],
                [end.lat, end.lng]
            ], {
                color: 'red',
                weight: 3,
                opacity: 0.7,
                dashArray: '10, 10'
            }).addTo(map);

            // Fit bounds to show both markers
            const bounds = L.latLngBounds([
                [start.lat, start.lng],
                [end.lat, end.lng]
            ]);
            map.fitBounds(bounds, { padding: [50, 50] });
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius of the earth in km
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lon2 - lon1);
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c; // Distance in km
        }

        function deg2rad(deg) {
            return deg * (Math.PI/180);
        }

        // Confirm emergency call
        document.getElementById('confirmEmergency').addEventListener('click', function() {
            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Dispatching Ambulance...';
            
            // Simulate API call delay
            setTimeout(() => {
                alert('Emergency services have been notified and are on their way!');
                $('#emergencyMapModal').modal('hide');
            }, 2000);
        });

        function verifyPrescription() {
            const medications = document.getElementById('medications').value;
            const notes = document.getElementById('additional-notes').value;
            const imageInput = document.getElementById('prescription-image');
            const messagesDiv = document.getElementById('prescription-messages');

            // Create FormData for file upload
            const formData = new FormData();
            formData.append('medications', medications);
            formData.append('notes', notes);
            if (imageInput.files.length > 0) {
                formData.append('image', imageInput.files[0]);
            }

            // Show loading state
            messagesDiv.innerHTML += `
                <div class="alert alert-info">
                    <i class="fas fa-spinner fa-spin"></i> Analyzing your medications...
                </div>
            `;

            // Send to backend
            fetch('/verify-prescription', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                // Add verification result
                messagesDiv.innerHTML += `
                    <div class="alert alert-${data.safe ? 'success' : 'warning'}">
                        <h6><i class="fas fa-${data.safe ? 'check' : 'exclamation'}-circle"></i> 
                            ${data.safe ? 'Safe to Proceed' : 'Potential Issues Detected'}</h6>
                        <p>${data.message}</p>
                        ${data.recommendations ? `<p><strong>Recommendations:</strong> ${data.recommendations}</p>` : ''}
                    </div>
                `;
            })
            .catch(error => {
                messagesDiv.innerHTML += `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i> Error analyzing prescription. Please try again.
                    </div>
                `;
            });
        }
    </script>

    <script>
        // Add smooth scrolling for navigation
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    const headerOffset = 70; // Adjust based on navbar height
                    const elementPosition = target.getBoundingClientRect().top;
                    const offsetPosition = elementPosition + window.pageYOffset - headerOffset;

                    window.scrollTo({
                        top: offsetPosition,
                        behavior: 'smooth'
                    });
                }
            });
        });

        // Highlight active nav item based on scroll position
        window.addEventListener('scroll', function() {
            const sections = ['home', 'ai-section', 'prescription-section'];
            let current = '';

            sections.forEach(section => {
                const element = document.getElementById(section);
                if (element) {
                    const rect = element.getBoundingClientRect();
                    if (rect.top <= 100) {
                        current = section;
                    }
                }
            });

            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href') === `#${current}`) {
                    link.classList.add('active');
                }
            });
        });
    </script>
</body>
</html>